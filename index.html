<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>è‹±æ±‰è¯æ±‡é—ªå¡</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    :root {
      --card-w: 88vw; --card-max-w: 520px;
      --card-h: 60vh; --card-max-h: 600px;
      --radius: 14px;
      --shadow: 0 8px 24px rgba(0,0,0,0.08);
      --brand: #0f766e;
    }
    * { box-sizing: border-box; }
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "PingFang SC","Noto Sans SC","Microsoft YaHei", sans-serif;
      margin: 0; padding: 0;
      min-height: 100vh; background: #f7faf9;
      display: flex; flex-direction: column; align-items: center;
    }
    .site-header { display:flex; align-items:center; gap:14px; margin:20px 16px 6px; }
    .site-header img { height:72px; width:auto; }
    .site-title { font-weight: 800; font-size: 1.25rem; color:#0b3c39; text-align: center;}
    .site-instruction { margin: 0 16px 14px; color:#334; }

    .card-container {
      position: relative;
      width: var(--card-w); max-width: var(--card-max-w);
      height: var(--card-h); max-height: var(--card-max-h);
      perspective: 1000px;
      margin-bottom: 12px;
    }
    .card {
      position: absolute; inset: 0;
      transform-style: preserve-3d;
      transition: transform .6s ease;
    }
    .front, .back {
      position: absolute; inset: 0;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      border-radius: var(--radius); background: #fff; border:1px solid #e8ebe9; box-shadow: var(--shadow);
      padding: 28px;
      backface-visibility: hidden;
    }
    .back { transform: rotateY(180deg); }
    .card.flipped { transform: rotateY(180deg); }

    .word { font-size: clamp(2.2rem, 8vw, 3.2rem); font-weight: 800; color:#0b3c39; text-align:center; line-height:1.05; }
    .phon { margin-top: 10px; font-size: clamp(1rem, 3.5vw, 1.4rem); color:#6b7c7a; font-weight: 500; letter-spacing:.3px; }
    .translation-zh { font-size: clamp(1.4rem, 4.5vw, 1.8rem); color:#0b3c39; font-weight: 700; text-align:center; }
    .example { margin-top: 14px; width:100%; max-width: 520px; text-align:center; }
    .ex-en { font-size: 1.05rem; color:#1f2937; margin-bottom: 6px; text-align:center; }
    .ex-zh { font-size: 1.05rem; color:#374151; text-align:center; }
    .highlight { font-weight: 800; color: var(--brand); }

    .audio-front, .audio-back { margin-top: 16px; font-size: 1.4rem; cursor:pointer; user-select:none; }
    .buttons-container { display:flex; gap:10px; width: var(--card-w); max-width: var(--card-max-w); margin-bottom: 16px; }
    .btn { flex:1; padding: 12px; border:none; border-radius: 10px; font-size:1rem; cursor:pointer; box-shadow: 0 2px 4px rgba(0,0,0,.06); }
    .know { background:#c7f9cc; }
    .practice { background:#ffddd2; }

    .nav { display:flex; justify-content:space-between; width:var(--card-w); max-width: var(--card-max-w); margin-bottom: 16px; }
    .nav button { font-size:2rem; background:none; border:none; cursor:pointer; }

    .hidden { display:none; }

    #congratsMsg {
      position:absolute; inset:0; background:#fff; border-radius:var(--radius); box-shadow: var(--shadow); padding: 20px;
    }
    #congratsMsg:not(.hidden) { display:flex; flex-direction:column; align-items:center; justify-content:center; z-index: 2; gap: 10px; }
    #congratsMsg input { padding:10px; border:1px solid #e5e7eb; border-radius:10px; width: 100%; max-width: 320px; }
    #congratsActions { display:flex; gap:10px; flex-wrap:wrap; justify-content:center; }
    #downloadPdfBtn { background:#dbeafe; }
    #reviewAll { background:#e5e7eb; }

    footer { margin-top:auto; font-size:.85rem; color:#6b7280; text-align:center; padding: 18px 10px; width:100%; }

    @media print {
      body { background: #fff; }
      .site-header, .site-instruction, .card-container, .buttons-container, .nav, #reviewControls, footer, #congratsMsg { display: none !important; }
      #pdfReport { display: block !important; }
    }
    #pdfReport { display:none; padding: 24px; max-width: 980px; margin: 0 auto; font-size: 14px; color:#111827; }
    #pdfReport h1 { font-size: 1.5rem; margin: 0 0 8px; }
    #pdfReport h2 { font-size: 1.2rem; margin: 18px 0 8px; }
    #pdfReport table { width:100%; border-collapse: collapse; margin-top: 8px; }
    #pdfReport th, #pdfReport td { border: 1px solid #e5e7eb; padding: 8px; text-align: left; }
    #pdfReport .muted { color:#6b7280; }
    #pdfReport .score-row { font-size: 1.3rem; font-weight: 800; color: var(--brand); }
  </style>
</head>
<body>

  <div class="site-header">
    <img src="LOGO.png" alt="BFSU Logo">
    <div class="site-title" id="siteTitle">è¯æ±‡é—ªå¡</div>
  </div>
  <p class="site-instruction" id="siteInstr">ç‚¹å‡»å¡ç‰‡ä»¥ç¿»è½¬ã€‚ç‚¹å‡»éŸ³é¢‘å›¾æ ‡ğŸ”Šå¯æ”¶å¬å•è¯æˆ–å¥å­ã€‚</p>

  <div class="card-container">
    <div id="card" class="card">
      <div class="front" role="button" aria-label="ç¿»è½¬å¡ç‰‡">
        <div id="frontWord" class="word"></div>
        <div id="frontPhon" class="phon"></div>
        <button id="audioFront" class="audio-front" title="æ’­æ”¾å•è¯éŸ³é¢‘" aria-label="æ’­æ”¾å•è¯éŸ³é¢‘">ğŸ”Š</button>
      </div>
      <div class="back" role="button" aria-label="ç¿»è½¬å¡ç‰‡">
        <div id="backTransZh" class="translation-zh"></div>
        <div class="example">
          <div id="exEn" class="ex-en"></div>
          <div id="exZh" class="ex-zh"></div>
        </div>
        <button id="audioBack" class="audio-back" title="æ’­æ”¾ä¾‹å¥éŸ³é¢‘" aria-label="æ’­æ”¾ä¾‹å¥éŸ³é¢‘">ğŸ”Š</button>
      </div>
    </div>
    <div id="congratsMsg" class="hidden">
      <h2>å¤ªæ£’äº†ï¼ğŸ‰</h2>
      <input id="studentId" placeholder="å§“å / å­¦å·ï¼ˆå¯é€‰ï¼‰">
      <div id="congratsSummary" class="muted"></div>
      <div id="congratsActions">
        <button id="downloadPdfBtn" class="btn">ä¸‹è½½ PDF</button>
        <button id="reviewAll" class="btn">å¤ä¹ æ‰€æœ‰å•è¯</button>
      </div>
    </div>
  </div>

  <div class="buttons-container">
    <button id="knowBtn" class="btn know">å·²æŒæ¡</button>
    <button id="practiceBtn" class="btn practice">éœ€è¦ç»ƒä¹ </button>
  </div>

  <div class="nav">
    <button id="prevBtn" aria-label="ä¸Šä¸€å¼ ">&larr;</button>
    <button id="nextBtn" aria-label="ä¸‹ä¸€å¼ ">&rarr;</button>
  </div>

  <div id="reviewControls" class="hidden">
    <button id="reviewPractice" class="btn">å¤ä¹ â€œéœ€è¦ç»ƒä¹ â€</button>
  </div>

  <!-- éšè—çš„å¯æ‰“å°æŠ¥å‘Šï¼šåªå«æ‘˜è¦ -->
  <section id="pdfReport">
    <h1>å­¦ä¹ è¡¨ç°æŠ¥å‘Š</h1>
    <div id="reportMeta"></div>
    <h2>æ‘˜è¦</h2>
    <table>
      <tbody id="summaryTable"></tbody>
    </table>
    <p class="muted">æ­¤æŠ¥å‘Šç”±å‰ç«¯é¡µé¢æœ¬åœ°ç”Ÿæˆï¼Œå¯æ”¾å¿ƒä¿å­˜å¹¶å‘é€ç»™è€å¸ˆã€‚</p>
  </section>

  <footer>Â©2025 Dr. Carlos Cardenas â€¢ æ•™è‚²ç®¡ç†å­¦åšå£«</footer>

  <script>
    // ====== è¯è¡¨æ•°æ®ï¼ˆåŠ¨æ€ï¼šéšæ•°ç»„é•¿åº¦è‡ªåŠ¨è®¡ç®—åˆ†å€¼ï¼‰ ======
    const wordsAll = [
      {"english":"math","phonetic":"/mÃ¦Î¸/","translation_zh":"æ•°å­¦","example_en":"Math is challenging. It takes me a long time to finish my homework.","example_zh":"æ•°å­¦å¾ˆæœ‰æŒ‘æˆ˜æ€§ã€‚æˆ‘åšä½œä¸šè¦èŠ±å¾ˆé•¿æ—¶é—´ã€‚"},
      {"english":"literature","phonetic":"/ËˆlÉªt.rÉ™.tÊƒÉ™r/","translation_zh":"æ–‡å­¦","example_en":"Literature is fascinating. I always want to read more.","example_zh":"æ–‡å­¦å¾ˆè¿·äººã€‚æˆ‘æ€»æ˜¯æƒ³å¤šè¯»ä¸€äº›ã€‚"},
      {"english":"history","phonetic":"/ËˆhÉªs.t(É™)ri/","translation_zh":"å†å²","example_en":"History is thought-provoking. It makes me think about the past.","example_zh":"å†å²å‘äººæ·±çœã€‚å®ƒè®©æˆ‘æ€è€ƒè¿‡å»ã€‚"},
      {"english":"business","phonetic":"/ËˆbÉªz.nÉªs/","translation_zh":"å•†ä¸š","example_en":"Business is competitive. Many people want to be the best.","example_zh":"å•†ä¸šå¾ˆæœ‰ç«äº‰åŠ›ã€‚å¾ˆå¤šäººæƒ³æˆä¸ºæœ€ä¼˜ç§€çš„ã€‚"},
      {"english":"graphic design","phonetic":"/ËŒÉ¡rÃ¦f.Éªk dÉªËˆzaÉªn/","translation_zh":"å¹³é¢è®¾è®¡","example_en":"Graphic design is fun. I enjoy making new pictures.","example_zh":"å¹³é¢è®¾è®¡å¾ˆæœ‰è¶£ã€‚æˆ‘å–œæ¬¢ç”»æ–°å›¾ã€‚"},
      {"english":"art","phonetic":"/É‘Ët/","translation_zh":"è‰ºæœ¯","example_en":"Art is inspiring. It makes me want to create something.","example_zh":"è‰ºæœ¯å¾ˆé¼“èˆäººå¿ƒã€‚å®ƒè®©æˆ‘æƒ³åˆ›ä½œä¸œè¥¿ã€‚"},
      {"english":"chemistry","phonetic":"/Ëˆkem.Éª.stri/","translation_zh":"åŒ–å­¦","example_en":"Chemistry is complicated. There are many rules to remember.","example_zh":"åŒ–å­¦å¾ˆå¤æ‚ã€‚æœ‰å¾ˆå¤šè§„åˆ™è¦è®°ä½ã€‚"},
      {"english":"physics","phonetic":"/ËˆfÉªz.Éªks/","translation_zh":"ç‰©ç†","example_en":"Physics is logical. The answers follow clear rules.","example_zh":"ç‰©ç†å¾ˆæœ‰é€»è¾‘æ€§ã€‚ç­”æ¡ˆéµå¾ªæ˜ç¡®çš„è§„åˆ™ã€‚"},
      {"english":"geography","phonetic":"/dÊ’iËˆÉ’É¡.rÉ™.fi/","translation_zh":"åœ°ç†","example_en":"Geography is interesting. I like learning about new places.","example_zh":"åœ°ç†å¾ˆæœ‰è¶£ã€‚æˆ‘å–œæ¬¢äº†è§£æ–°çš„åœ°æ–¹ã€‚"},
      {"english":"biology","phonetic":"/baÉªËˆÉ’l.É™.dÊ’i/","translation_zh":"ç”Ÿç‰©","example_en":"Biology is practical. It helps me understand living things.","example_zh":"ç”Ÿç‰©å¾ˆå®ç”¨ã€‚å®ƒå¸®åŠ©æˆ‘äº†è§£ç”Ÿç‰©ã€‚"},
      {"english":"physical education","phonetic":"/ËŒfÉªz.Éª.kÉ™l ed.jÊŠËˆkeÉª.ÊƒÉ™n/","translation_zh":"ä½“è‚²","example_en":"Physical education is energetic. We move a lot in class.","example_zh":"ä½“è‚²è¯¾å¾ˆæœ‰æ´»åŠ›ã€‚æˆ‘ä»¬åœ¨è¯¾å ‚ä¸Šæ´»åŠ¨å¾ˆå¤šã€‚"},
      {"english":"graduate","phonetic":"/ËˆÉ¡rÃ¦dÊ’.u.É™t/","translation_zh":"æ¯•ä¸šç”Ÿ","example_en":"Graduate study is serious. You must work very hard.","example_zh":"ç ”ç©¶ç”Ÿå­¦ä¹ å¾ˆä¸¥è‚ƒã€‚ä½ å¿…é¡»éå¸¸åŠªåŠ›ã€‚"},
      {"english":"undergraduate","phonetic":"/ËŒÊŒn.dÉ™ËˆÉ¡rÃ¦dÊ’.u.É™t/","translation_zh":"æœ¬ç§‘ç”Ÿ","example_en":"Undergraduate life is exciting. There are many new things to try.","example_zh":"æœ¬ç§‘ç”Ÿæ´»å¾ˆä»¤äººå…´å¥‹ã€‚æœ‰å¾ˆå¤šæ–°äº‹ç‰©å¯ä»¥å°è¯•ã€‚"},
      {"english":"university","phonetic":"/ËŒjuË.nÉªËˆvÉœË.sÉª.ti/","translation_zh":"å¤§å­¦","example_en":"University is amazing. You can meet many different people.","example_zh":"å¤§å­¦å¾ˆæ£’ã€‚ä½ å¯ä»¥è®¤è¯†å¾ˆå¤šä¸åŒçš„äººã€‚"},
      {"english":"exchange program","phonetic":"/ÉªksËˆtÊƒeÉªndÊ’ ËŒprÉ™ÊŠ.É¡rÃ¦m/","translation_zh":"äº¤æ¢é¡¹ç›®","example_en":"An exchange program is motivating. It makes me want to study more.","example_zh":"äº¤æ¢é¡¹ç›®å¾ˆæœ‰æ¿€åŠ±ä½œç”¨ã€‚å®ƒè®©æˆ‘æƒ³æ›´åŠªåŠ›å­¦ä¹ ã€‚"},
      {"english":"easy","phonetic":"/ËˆiË.zi/","translation_zh":"å®¹æ˜“çš„","example_en":"Geography is easy. I can remember the country names.","example_zh":"åœ°ç†å¾ˆå®¹æ˜“ã€‚æˆ‘èƒ½è®°ä½å›½å®¶çš„åå­—ã€‚"},
      {"english":"boring","phonetic":"/ËˆbÉ”Ë.rÉªÅ‹/","translation_zh":"æ— èŠçš„","example_en":"Literature is boring. I donâ€™t enjoy reading long books.","example_zh":"æ–‡å­¦å¾ˆæ— èŠã€‚æˆ‘ä¸å–œæ¬¢è¯»é•¿ç¯‡ä¹¦ã€‚"},
      {"english":"useful","phonetic":"/ËˆjuËs.fÉ™l/","translation_zh":"æœ‰ç”¨çš„","example_en":"Math is useful. I can use it to plan my budget.","example_zh":"æ•°å­¦å¾ˆæœ‰ç”¨ã€‚æˆ‘å¯ä»¥ç”¨å®ƒæ¥è®¡åˆ’é¢„ç®—ã€‚"},
      {"english":"fun","phonetic":"/fÊŒn/","translation_zh":"æœ‰è¶£çš„","example_en":"Undergraduate study is fun. I can join many clubs.","example_zh":"æœ¬ç§‘å­¦ä¹ å¾ˆæœ‰è¶£ã€‚æˆ‘å¯ä»¥åŠ å…¥å¾ˆå¤šç¤¾å›¢ã€‚"},
      {"english":"tiring","phonetic":"/ËˆtaÉªÉ™.rÉªÅ‹/","translation_zh":"ç´¯äººçš„","example_en":"Physical education is tiring. I need to rest after class.","example_zh":"ä½“è‚²è¯¾å¾ˆç´¯ã€‚ä¸‹è¯¾åæˆ‘éœ€è¦ä¼‘æ¯ã€‚"},
      {"english":"logical","phonetic":"/ËˆlÉ’dÊ’.Éª.kÉ™l/","translation_zh":"åˆé€»è¾‘çš„","example_en":"Chemistry is logical. The results follow the rules.","example_zh":"åŒ–å­¦å¾ˆæœ‰é€»è¾‘æ€§ã€‚ç»“æœéµå¾ªè§„åˆ™ã€‚"},
      {"english":"confusing","phonetic":"/kÉ™nËˆfjuË.zÉªÅ‹/","translation_zh":"ä»¤äººå›°æƒ‘çš„","example_en":"Math is confusing. I donâ€™t understand some of the problems.","example_zh":"æ•°å­¦è®©äººå›°æƒ‘ã€‚æˆ‘ä¸ç†è§£æœ‰äº›é¢˜ç›®ã€‚"},
      {"english":"interesting","phonetic":"/ËˆÉªn.trÉ™.stÉªÅ‹/","translation_zh":"æœ‰è¶£çš„","example_en":"History is interesting. I love hearing the stories.","example_zh":"å†å²å¾ˆæœ‰è¶£ã€‚æˆ‘å–œæ¬¢å¬è¿™äº›æ•…äº‹ã€‚"},
      {"english":"inspiring","phonetic":"/ÉªnËˆspaÉªÉ™.rÉªÅ‹/","translation_zh":"é¼“èˆäººå¿ƒçš„","example_en":"Literature is inspiring. It makes me want to write.","example_zh":"æ–‡å­¦å¾ˆé¼“èˆäººå¿ƒã€‚å®ƒè®©æˆ‘æƒ³å†™ä½œã€‚"},
      {"english":"exciting","phonetic":"/ÉªkËˆsaÉª.tÉªÅ‹/","translation_zh":"ä»¤äººå…´å¥‹çš„","example_en":"Graduate life is exciting. There are many new experiences.","example_zh":"ç ”ç©¶ç”Ÿç”Ÿæ´»å¾ˆä»¤äººå…´å¥‹ã€‚æœ‰å¾ˆå¤šæ–°ä½“éªŒã€‚"},
      {"english":"serious","phonetic":"/ËˆsÉªÉ™.ri.É™s/","translation_zh":"ä¸¥è‚ƒçš„","example_en":"University life is serious. The exams are very important.","example_zh":"å¤§å­¦ç”Ÿæ´»å¾ˆä¸¥è‚ƒã€‚è€ƒè¯•å¾ˆé‡è¦ã€‚"},
      {"english":"complicated","phonetic":"/ËˆkÉ’m.plÉª.keÉª.tÉªd/","translation_zh":"å¤æ‚çš„","example_en":"Biology is complicated. It has many details.","example_zh":"ç”Ÿç‰©å¾ˆå¤æ‚ã€‚å®ƒæœ‰å¾ˆå¤šç»†èŠ‚ã€‚"},
      {"english":"amazing","phonetic":"/É™ËˆmeÉª.zÉªÅ‹/","translation_zh":"æƒŠäººçš„","example_en":"Geography is amazing. There are many beautiful places.","example_zh":"åœ°ç†å¾ˆæƒŠäººã€‚æœ‰å¾ˆå¤šç¾ä¸½çš„åœ°æ–¹ã€‚"},
      {"english":"important","phonetic":"/ÉªmËˆpÉ”Ë.tÉ™nt/","translation_zh":"é‡è¦çš„","example_en":"History is important. It helps us understand todayâ€™s world.","example_zh":"å†å²å¾ˆé‡è¦ã€‚å®ƒå¸®åŠ©æˆ‘ä»¬äº†è§£ä»Šå¤©çš„ä¸–ç•Œã€‚"},
      {"english":"challenging","phonetic":"/ËˆtÊƒÃ¦l.Éªn.dÊ’ÉªÅ‹/","translation_zh":"æœ‰æŒ‘æˆ˜æ€§çš„","example_en":"Physics is challenging. Some ideas are hard to understand.","example_zh":"ç‰©ç†å¾ˆæœ‰æŒ‘æˆ˜æ€§ã€‚æœ‰äº›æ¦‚å¿µå¾ˆéš¾ç†è§£ã€‚"}
    ];

    // === Deck helpers (dynamic) ===
    const words = wordsAll; // if you want a subset, use wordsAll.slice(0, N)
    function getAllIndices() { return words.map((_, i) => i); }
    function totalTerms() { return words.length; }

    // App state (dynamic)
    let INITIAL_INDICES = getAllIndices();
    let currentIndices = [...INITIAL_INDICES];
    let practiceIndices = [];
    let index = 0;
    let practiceMode = false;
    const startedAt = Date.now();

    // Track first decision per card for fair scoring out of totalTerms()
    const firstDecision = new Map(); // key = index (0..N-1), value = 'know' | 'practice'

    // ===== DOM =====
    const cardEl = document.getElementById('card');
    const frontWordEl = document.getElementById('frontWord');
    const frontPhonEl = document.getElementById('frontPhon');
    const backTransZhEl = document.getElementById('backTransZh');
    const exEnEl = document.getElementById('exEn');
    const exZhEl = document.getElementById('exZh');
    const audioFrontEl = document.getElementById('audioFront');
    const audioBackEl = document.getElementById('audioBack');
    const congratsEl = document.getElementById('congratsMsg');
    const reviewControlsEl = document.getElementById('reviewControls');
    const congratsSummaryEl = document.getElementById('congratsSummary');
    const siteTitleEl = document.getElementById('siteTitle');
    const siteInstrEl = document.getElementById('siteInstr');

    // Set dynamic title/instructions
    function refreshHeader() {
      siteTitleEl.innerHTML = `æ•™è‚²éƒ¨ - å‡ºå›½äººå‘˜åŸ¹è®­éƒ¨<br/>ç¬¬1å‘¨ â€¢ è‹±â†’ä¸­ é—ªå¡`;
      siteInstrEl.innerHTML = `ç‚¹å‡»å¡ç‰‡ä»¥ç¿»è½¬ã€‚ç‚¹å‡»éŸ³é¢‘å›¾æ ‡ğŸ”Šå¯æ”¶å¬å•è¯æˆ–å¥å­ã€‚`;
    }
    refreshHeader();

    function showCard() {
      const w = words[currentIndices[index]];
      frontWordEl.textContent = w.english;
      frontPhonEl.textContent = w.phonetic;
      backTransZhEl.textContent = w.translation_zh;
      exEnEl.innerHTML = highlightWord(w.example_en, w.english);
      exZhEl.textContent = w.example_zh;
      cardEl.classList.remove('flipped');
    }

    // === FIXED: proper regex escape + highlighter ===
    function esc(s) {
      return s.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    }
    function highlightWord(sentence, word) {
      const pattern = new RegExp(`\\b${esc(word)}\\b`, 'gi');
      return sentence.replace(pattern, (m) => `<span class="highlight">${m}</span>`);
    }

    // ç‚¹å‡»ç¿»è½¬
    cardEl.addEventListener('click', () => { cardEl.classList.toggle('flipped'); });

    // ===== Independent audio per side =====
    const AUDIO_BASE = 'audio/';
    function slugify(text) { return text.toLowerCase().replace(/[^a-z\s]/g, '').trim().replace(/\s+/g, '_'); }
    function wordAudioName(english){ return slugify(english) + '.mp3'; }
    function sentAudioName(english){ return slugify(english) + '_sen.mp3'; }
    function audioUrl(name) { return AUDIO_BASE + name; }
    function playWord() {
      const w = words[currentIndices[index]];
      new Audio(audioUrl(wordAudioName(w.english))).play().catch(()=>{});
    }
    function playSentence() {
      const w = words[currentIndices[index]];
      new Audio(audioUrl(sentAudioName(w.english))).play().catch(()=>{});
    }
    audioFrontEl.addEventListener('click', (e) => { e.stopPropagation(); playWord(); });
    audioBackEl.addEventListener('click', (e) => { e.stopPropagation(); playSentence(); });

    // ===== Buttons =====
    document.getElementById('knowBtn').addEventListener('click', () => { record('know'); nextCard(); });
    document.getElementById('practiceBtn').addEventListener('click', () => { record('practice'); nextCard(); });

    function record(action) {
      const cardIdx = currentIndices[index];
      if (!firstDecision.has(cardIdx)) firstDecision.set(cardIdx, action);
      if (action === 'practice' && !practiceIndices.includes(cardIdx)) practiceIndices.push(cardIdx);
    }

    function nextCard() {
      if (index < currentIndices.length - 1) {
        index++;
        showCard();
      } else {
        cardEl.classList.add('hidden');
        if (!practiceMode && practiceIndices.length > 0) {
          reviewControlsEl.classList.remove('hidden');
        } else {
          const s = computeSummary();
          congratsSummaryEl.textContent = `æŒæ¡ï¼š${s.known}/${s.total} â€¢ éœ€ç»ƒä¹ ï¼š${s.practice}/${s.total} â€¢ å¾—åˆ†ï¼š${s.score}%`;
          congratsEl.classList.remove('hidden');
        }
      }
    }

    document.getElementById('reviewPractice').addEventListener('click', () => {
      practiceMode = true;
      currentIndices = [...practiceIndices];
      index = 0;
      reviewControlsEl.classList.add('hidden');
      congratsEl.classList.add('hidden');
      cardEl.classList.remove('hidden');
      showCard();
    });

    document.getElementById('reviewAll').addEventListener('click', () => {
      // reset to the full, dynamic deck
      practiceMode = false;
      INITIAL_INDICES = getAllIndices();
      currentIndices = [...INITIAL_INDICES];
      practiceIndices = [];
      index = 0;
      congratsEl.classList.add('hidden');
      reviewControlsEl.classList.add('hidden');
      refreshHeader();
      showCard();
    });

    document.getElementById('prevBtn').addEventListener('click', () => { if (index > 0) { index--; showCard(); } });
    document.getElementById('nextBtn').addEventListener('click', () => nextCard());

    function computeSummary() {
      // Dynamic score out of total terms
      const total = totalTerms();
      let known = 0;
      getAllIndices().forEach(i => { if (firstDecision.get(i) === 'know') known++; });
      const practice = total - known;
      const score = Math.round((known / Math.max(total,1)) * 100);
      return { known, practice, score, total };
    }

    // ===== PDF å¯¼å‡ºï¼ˆæ‰“å°ä¸º PDFï¼‰ =====
    function buildReport() {
      const student = (document.getElementById('studentId').value || '').trim();
      const finishedAt = new Date();
      const started = new Date(startedAt);
      const s = computeSummary();

      const meta = [
        `<div><strong>è¯åº“ï¼š</strong>ç¬¬1å‘¨ â€¢ è‹±â†’ä¸­ï¼ˆå…± ${s.total} ä¸ªè¯æ¡ï¼‰</div>`,
        `<div><strong>å­¦ç”Ÿï¼š</strong> ${student || 'ï¼ˆæœªå¡«å†™ï¼‰'}</div>`,
        `<div><strong>å¼€å§‹æ—¶é—´ï¼š</strong> ${started.toLocaleString()}</div>`,
        `<div><strong>ç»“æŸæ—¶é—´ï¼š</strong> ${finishedAt.toLocaleString()}</div>`
      ].join('');
      document.getElementById('reportMeta').innerHTML = meta;

      const st = document.getElementById('summaryTable');
      st.innerHTML = `
        <tr><th>æ€»è¯æ•°</th><td>${s.total}</td></tr>
        <tr><th>å·²æŒæ¡</th><td>${s.known}</td></tr>
        <tr><th>éœ€è¦ç»ƒä¹ </th><td>${s.practice}</td></tr>
        <tr class="score-row"><th>å¾—åˆ†</th><td>${s.score}%</td></tr>
      `;
    }

    document.getElementById('downloadPdfBtn').addEventListener('click', () => {
      buildReport();
      window.print(); // é€‰æ‹©â€œå¦å­˜ä¸º PDFâ€
    });

    // åˆå§‹åŒ–ï¼šè½½å…¥é¦–å¼ 
    showCard();
  </script>
</body>
</html>
